;=====================================
; Minimal Dialplan for SIP Endpoint Model
; All call control handled by Genesys or ARI
;=====================================

[general]
static=yes
writeprotect=no
clearglobalvars=no

;=====================================
; ARI/Stasis Context
; For WebRTC Gateway ARI application
;=====================================

[webrtc-gateway-stasis]
; Entry point for ARI-controlled calls
exten => _X.,1,NoOp(ARI Call Control for ${EXTEN})
 same => n,Stasis(webrtc-gateway)
 same => n,Hangup()

;=====================================
; Agent Context (From WebRTC Clients)
; Forward everything to Genesys or use for local testing
;=====================================

[genesys-agent]
; All calls from agents go directly to Genesys OR use ARI
; For now, route to other extensions for testing

; Echo test - for local testing (optional)
exten => 9999,1,NoOp(Echo Test)
 same => n,Answer()
 same => n,Wait(1)
 same => n,Playback(demo-echotest)
 same => n,Echo()
 same => n,Hangup()

; Call other agents (1XXX, 5XXX) - Route EVERYTHING through Genesys T-Server
; This ensures T-Server can notify WWE about incoming calls and track DN status
exten => _1XXX,1,NoOp(Agent ${CALLERID(num)} calling ${EXTEN} via Genesys)
 same => n,Set(CALLERID(name)=Agent ${CALLERID(num)})
 ; Forward to Genesys SIP Server - T-Server will route back to Asterisk
 same => n,Dial(PJSIP/${EXTEN}@genesys_sip_server,300)
 same => n,Hangup()

exten => _5XXX,1,NoOp(Agent ${CALLERID(num)} calling ${EXTEN} via Genesys)
 same => n,Set(CALLERID(name)=Agent ${CALLERID(num)})
 ; Forward to Genesys SIP Server - T-Server will route back to Asterisk
 same => n,Dial(PJSIP/${EXTEN}@genesys_sip_server,300)
 same => n,Hangup()

; Route everything else to Genesys SIP Server
exten => _X.,1,NoOp(Agent ${CALLERID(num)} calling ${EXTEN} via Genesys)
 same => n,Set(CALLERID(name)=Agent ${CALLERID(num)})
 ; Forward to Genesys SIP Server
 same => n,Dial(PJSIP/${EXTEN}@genesys_sip_server,300)
 same => n,Hangup()

; Fallback
exten => i,1,NoOp(Invalid number dialed)
 same => n,Playback(invalid)
 same => n,Hangup()

exten => t,1,NoOp(Timeout)
 same => n,Hangup()

;=====================================
; From Genesys Context
; Incoming calls from Genesys to Agent DNs
;=====================================

[from-genesys]
; Calls from Genesys to agent DNs (5001-5999)

exten => _5XXX,1,NoOp(Call from Genesys to Agent DN ${EXTEN})
 same => n,Set(CALLERID(name)=${CALLERID(name)})
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 ; Ring the WebRTC client
 same => n,Dial(PJSIP/${EXTEN},30)
 same => n,Hangup()

; Calls to DNs 1001-1999 (agent DNs)
exten => _1XXX,1,NoOp(Call from Genesys to Agent DN ${EXTEN})
 same => n,Set(CALLERID(name)=${CALLERID(name)})
 same => n,Set(CALLERID(num)=${CALLERID(num)})
 ; Ring the WebRTC client
 same => n,Dial(PJSIP/${EXTEN},30,r)
 same => n,Hangup()

; Catch-all for any other number pattern
exten => _X.,1,NoOp(Call from Genesys to ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30)
 same => n,Hangup()

; No answer
exten => h,1,NoOp(Call ended)
 same => n,Hangup()

;=====================================
; Notes:
; - No IVR - handled by Genesys
; - No queues - handled by Genesys
; - No voicemail - handled by Genesys
; - No transfers - handled by Genesys Workspace
; - No conferencing - handled by Genesys
; - Asterisk is just a SIP/WebRTC gateway
; - ARI context allows programmatic call control
;=====================================





