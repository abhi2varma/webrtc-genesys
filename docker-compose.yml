services:
  asterisk:
    image: andrius/asterisk:latest
    container_name: webrtc-asterisk
    hostname: asterisk
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./asterisk/etc:/etc/asterisk
      - ./asterisk/sounds:/var/lib/asterisk/sounds
      - ./asterisk/keys:/etc/asterisk/keys
      - ./asterisk/logs:/var/log/asterisk
      - ./certs:/etc/certs:ro
    environment:
      - ASTERISK_UID=1000
      - ASTERISK_GID=1000
    cap_add:
      - NET_ADMIN
      - SYS_NICE
    depends_on:
      - coturn
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  coturn:
    image: coturn/coturn:latest
    container_name: webrtc-coturn
    hostname: coturn
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./coturn/turnserver.conf:/etc/turnserver.conf:ro
      - ./coturn/logs:/var/log/coturn
      - ./certs:/etc/certs:ro
    command:
      - "-c"
      - "/etc/turnserver.conf"
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  nginx:
    image: nginx:alpine
    container_name: webrtc-nginx
    ports:
      - "80:80"
      - "443:443"
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/html:/usr/share/nginx/html:ro
      - ./nginx/logs:/var/log/nginx
      - ./certs:/etc/certs:ro
    depends_on:
      - asterisk
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  registration-monitor:
    image: webrtc-registration-monitor
    container_name: webrtc-registration-monitor
    hostname: registration-monitor
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./registration-monitor/logs:/app/logs
    environment:
      - ASTERISK_HOST=127.0.0.1
      - ASTERISK_AMI_PORT=5038
      - ASTERISK_AMI_USER=admin
      - ASTERISK_AMI_SECRET=admin123
      - GENESYS_SIP_HOST=192.168.210.81
      - GENESYS_SIP_PORT=5060
      - DN_RANGE_START=5001
      - DN_RANGE_END=5020
      - LOG_LEVEL=INFO
      - REDIS_HOST=127.0.0.1
      - REDIS_PORT=6379
      - ASTERISK_INSTANCE_ID=54
      - ASTERISK_INSTANCE_IP=192.168.210.54
    depends_on:
      - asterisk
      - redis
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  dashboard-api:
    image: webrtc-dashboard-api
    build: ./dashboard
    container_name: webrtc-dashboard-api
    hostname: dashboard-api
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./dashboard/logs:/app/logs
    environment:
      - ASTERISK_HOST=127.0.0.1
      - ASTERISK_AMI_PORT=5038
      - ASTERISK_AMI_USER=admin
      - ASTERISK_AMI_SECRET=admin123
    depends_on:
      - asterisk
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  redis:
    image: redis:7-alpine
    container_name: webrtc-redis
    hostname: redis
    network_mode: host
    restart: unless-stopped
    command: redis-server --appendonly yes --port 6379
    volumes:
      - ./redis/data:/data
      - ./redis/logs:/var/log/redis
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  kamailio:
    build: ./kamailio
    image: webrtc-kamailio
    container_name: webrtc-kamailio
    hostname: kamailio
    network_mode: host
    restart: unless-stopped
    volumes:
      - ./kamailio/kamailio.cfg:/etc/kamailio/kamailio.cfg:ro
      - ./kamailio/dispatcher.list:/etc/kamailio/dispatcher.list:ro
      - ./kamailio/logs:/var/log/kamailio
    depends_on:
      - redis
      - asterisk
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"




